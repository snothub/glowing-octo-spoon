# docker compose build client --no-cache; docker compose up -d --force-recreate client
# docker compose build identity; docker compose up -d --force-recreate identity

# Reusable configuration blocks
x-common-extra-hosts: &common-extra-hosts
  - "idp.local:host-gateway"
  - "login.local:host-gateway"
  - "client.local:host-gateway"
  - "api.local:host-gateway"

x-common-cert-env: &common-cert-env
  ASPNETCORE_Kestrel__Certificates__Default__Path: /app/aspnetcore-dev-cert.pfx
  ASPNETCORE_Kestrel__Certificates__Default__Password: MyPw123

services:
  js-client:
    build:
      context: .
      dockerfile: Dockerfile_JavaScriptClient
    ports:
      - "6003:443"
    depends_on:
      - identity
    volumes:
      - ./aspnetcore-dev-cert.pfx:/app/aspnetcore-dev-cert.pfx  # Mount certificate into /app
    environment:
      <<: *common-cert-env
      IDP_AUTHORITY: ${IDP_AUTHORITY}
    extra_hosts: *common-extra-hosts

  js-frontend:
    build:
      context: .
      dockerfile: Dockerfile_FrontendHost
    ports:
      - "6001:443"
    depends_on:
      - identity
    volumes:
      - ./aspnetcore-dev-cert.pfx:/app/aspnetcore-dev-cert.pfx  # Mount certificate into /app
    environment:
      <<: *common-cert-env
      IDP_AUTHORITY: ${IDP_AUTHORITY}
    extra_hosts: *common-extra-hosts

  js-backend:
    build:
      context: .
      dockerfile: Dockerfile_BackendApiHost
    ports:
      - "6002:443"
    depends_on:
      - identity
    volumes:
      - ./aspnetcore-dev-cert.pfx:/app/aspnetcore-dev-cert.pfx  # Mount certificate into /app
    environment:
      <<: *common-cert-env
      IDP_AUTHORITY: ${IDP_AUTHORITY}
    extra_hosts: *common-extra-hosts

  client:
    build:
      context: .
      dockerfile: Dockerfile_Client
    ports:
      - "5001:443"
    depends_on:
      - identity
    volumes:
      - ./aspnetcore-dev-cert.pfx:/app/aspnetcore-dev-cert.pfx  # Mount certificate into /app
    environment:
      <<: *common-cert-env
      IDP_AUTHORITY: ${IDP_AUTHORITY}
    extra_hosts: *common-extra-hosts

  identity:
    build:
      context: .
      dockerfile: Dockerfile_Identity
    ports:
      - "${IDP_AUTHORITY_PORT}:443"
    volumes:
      - ./aspnetcore-dev-cert.pfx:/app/aspnetcore-dev-cert.pfx  # Mount certificate into /app
    environment:
      <<: *common-cert-env
      IDP_LOGINURL: ${IDP_LOGINAPP}/login
      IDP_LOGOUTURL: ${IDP_AUTHORITY}/logout
      IDP_CONSENTURL: ${IDP_LOGINAPP}/consent
      LogLevel: Debug
    extra_hosts: *common-extra-hosts

  api:
    build:
      context: .
      dockerfile: Dockerfile_Api
    volumes:
      - ./aspnetcore-dev-cert.pfx:/app/aspnetcore-dev-cert.pfx  # Mount certificate into /app
    ports:
      - "${IDP_API_PORT}:443"
    environment:
      <<: *common-cert-env
      LogLevel: Debug
    extra_hosts: *common-extra-hosts

  login-app:
    build:
      context: .
      dockerfile: Dockerfile_IdUi
      args:
        VITE_API_URL: ${IDP_AUTHORITY}
    ports:
      - "${IDP_LOGINAPP_PORT}:443"
    depends_on:
      - identity
    volumes:
      - ./aspnetcore-dev-cert.pfx:/app/aspnetcore-dev-cert.pfx
    extra_hosts: *common-extra-hosts
